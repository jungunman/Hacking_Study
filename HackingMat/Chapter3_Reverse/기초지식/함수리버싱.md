# 함수 리버싱
입력 값과 관련해 정확히 1개의 리턴값을 돌려주는 약속.<br>
함수 호출 시 입력값 전달 방법과 리턴값을 받는 방법에 대해 알아보는 마크업 파일이다.<br>
함수 프롤로그와 에필로그의 특징을 살펴볼 수 있다.<br>


## 콜링 컨벤션(Calling Convention)
함수 호출 시 인자를 전달받고 자신을 호출한 함수에게 리턴값을 돌려주는지에 대해 약속된 함수 호출 규약.<br><br>
__C언어에서 사용되는 대표적인 3개의 호출 규약.__<br>
| 구분 | __codecl | __stdcall | __fastcall |
|:---:|:---:|:---:|:---:|
| 인자 전달 방법 | 스택 | 스택 | 레지스터, 스택 |
| 스택 해제 방법 | 호출한 함수 | 호출된 함수 | 호출된 함수 |

### #__cdecl
Stack에 인자를 LIFO 형식으로 Push해서 인자를 전달하는 방법을 채택한다,<br>
함수 호출이 끝나면 그 이후 [ADD ESP,크기]만큼 스택을 해제하는 모습을 볼 수 있다.<br>
__cdecl 호출 규약은 호출한 함수에서 스택을 해제하기 때문에 호출된 함수에서는 스 택 해제에 대해 신경쓰지 않는다.<br>
스택 해제 방법에서 호출한 함수는 호출된 함수가 끝나고 호출한 함수로 돌아갔을 때 해제한다는 뜻이다.<br><br>

_FTZ 문제 풀 때, 함수에 인자를 전달하는 방식이 __cdecl 이었나보다._<br>


### #__stdcall
인자 전달 방법은 __cdecl과 같지만, 스택 해제 방법에서 차이가 보임.<br>
__cdecl에서 호출된 함수 내부에는 RETN의 명령어만 있고, 스택 해제하는 부분은 없었기에 호출한 함수 부분으로 돌아가기만하고,<br>
__stdcall 에서는 [RETN 0C]와 같이 호출한 함수로 돌아가면서 ESP를 0C만큼 더해주는 명령을 수행함.<br>
호출된 함수가 끝나고 다음 명령어를 수행할 때, 이미 인자 입력에 사용된 스택은 해제되었기에 스택을 효율적으로 사용할 수 있음.<br>

### #__fastcall
위 두 방법과 달리 인자 입력에 레지스터를 사용함.<br>
레지스터 사용에는 한계가 있기에 모든 인자를 레지스터로 입력하지 않고 스택(메모리)도 같이 사용함.<br>
스택 해제 방법은__stdcall과 같이 호출된 함수에서 해제하지만, 스택에 push된 크기만 해제할 뿐 레지스터에 저장된 값의 크기는 해제하지 않음.<br>


## 함수 호출 리턴값 확인
IA-32에서 함수의 리턴값은 EAX Register를 사용함.<br>
Call 명령어로 함수가 끝나고 EAX의 값을 특정 주소에 MOV 명령어로 값을 옮기는 것을 볼 수 있음.<br>
함수의 리턴값은 EAX로 주고 받을 수 있으며, 인자값을 전달할 떄도 레지스터를 이용할 수 있음<br>
__fastcall 부분 참고<br>

## 함수 프롤로그, 에필로그
함수 시작을 위해 스택과 레지스터를 재구성하는 프롤로그<br>
함수 종료 시  스택과 레지스터를 정리하는 에필로그<br><br>

### #함수 프롤로그
> PUSH EBP<br>
> MOV  EBP,ESP<br>

main함수를 디스어셈블할 때마다 볼 수 있는 프롤로그 부분<br>
가장 먼저 이전 함수에서 사용한 EBP를 Push하여 스택에 저장함<br>
현재 스택 위치를 EBP에 저장하여 함수 내부를 가리키도록 함<br><br>

### #함수 에필로그
> MOV  ESP,EBP<br>
> POP  EBP<br>
> RETN <br>

프롤로그와 반대로 동작함<br>
MOV 로 스택 위치를 함수 시작 전 위치로 되돌리고, POP을 통해 스택에 저장된 이전 EBP값을 EBP에 저장함.<br>
스택과 레지스터의 정리가 끝나면 RETN으로 호출한 함수로 되돌아감<br>
PUSH하는 과정은 없지만 인자들을 모두 PUSH하고 나서 함수로 들어가기 전 리턴 주소를 Push하여 함수에서 돌아왔을 때 EIP 레지스터가 실행할 다음 주소를 알 수 있게 해줌.<br>

## 지역변수, 전역변수, 포인터
어셈블리어에서 지역변수와 전역변수는 어떻게 선언되고, 포인터는 어떻게 값을 주고 받는지 확인함<br>

### #지역변수
지역 변수는 함수 내부에 선언된 변수를 말함<br>
어셈블리어에서는 [EBP-8] 같이 "EBP 기준 몇 번째 위치에 있다" 처럼 저장됨<br>
함수가 종료되면 함수의 스택이 해제되고, 지역변수도 더 이상 접근할 방법이 사라짐<br>
접근하더라도 무슨 값이 할당되었는지 모름.<br><br>

### #포인터
포인터 변수는 주소를 담은 변수임.<br>
포인터는 MOV명령어가 아닌 LEA 명령어로 주소를 EAX에 넘겨 푸쉬한 후 작업을 함<br>
주소로 계산하기 때문에, 지역 변수가 변경될 수 있음.<br>\
